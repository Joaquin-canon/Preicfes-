ğŸ”§ Prompt de contexto â€“ Proyecto Pre-ICFES (Backend FastAPI)

Estoy desarrollando una plataforma educativa llamada Pre-ICFES, enfocada en la preparaciÃ³n del examen ICFES, usando FastAPI + SQLAlchemy + MySQL, con renderizado HTML clÃ¡sico (Jinja2) y sin frontend SPA.

ğŸ§  Arquitectura general (ACTUAL Y FUNCIONAL)
Backend

Framework: FastAPI

ORM: SQLAlchemy (sÃ­ncrono)

Base de datos: MySQL (estructura ya creada, NO usar migraciones automÃ¡ticas)

Templates: Jinja2

JS: Vanilla JS (solo para UI, sin lÃ³gica backend)

Flujo: POST â†’ Redirect â†’ GET

ğŸ” AutenticaciÃ³n (IMPORTANTE â€“ NO CAMBIAR)
Enfoque correcto (Single Source of Truth)

âœ” Existe UN SOLO LOGIN centralizado
âœ” NO hay sesiones de servidor
âœ” NO hay mÃºltiples sistemas de auth
âœ” NO se duplica lÃ³gica de JWT

ImplementaciÃ³n real

JWT guardado en cookie HttpOnly

La cookie NO incluye Bearer, solo el token limpio

La cookie tiene:

path="/"

httponly=True

samesite="lax"

Archivos clave

app/routers/login.py

Ãšnico endpoint /login

Verifica credenciales

Genera JWT

Guarda cookie

Redirige segÃºn rol

app/core/auth/dependencies.py

get_current_user

Lee JWT desde cookie

Decodifica token

Retorna usuario desde BD

NO usa request.session

NO instala SessionMiddleware

ğŸ‘¤ Roles del sistema

admin

docente

coordinador

estudiante

Reglas

El rol viene en el JWT

Los routers NO hacen login

Los routers NO crean tokens

Los routers NO manejan cookies

ğŸ§­ Manejo de autenticaciÃ³n segÃºn tipo de ruta
Rutas HTML (GET)

âœ” Se valida usuario manualmente dentro de la funciÃ³n
âœ” Si no hay usuario â†’ RedirectResponse("/login")
âœ” NO usar Depends(get_current_user) directamente en GET HTML

Rutas POST / lÃ³gica

âœ” Se usa Depends(get_current_user)
âœ” Si falla â†’ error controlado
âœ” No se necesita redirect visual inmediato

ğŸ“š MÃ³dulo Test DiagnÃ³stico (estado actual)
Archivo principal

app/routers/admin/catalogo.py

Funcionalidad

Listado de preguntas diagnÃ³sticas

Modal HTML para crear preguntas

Guardado en BD con POST clÃ¡sico

RedirecciÃ³n correcta tras guardar

ğŸ§© Modelo Pregunta DiagnÃ³stico (NO ROMPER)
Tabla: pregunta_diagnostico

Campos importantes:

area_id (FK â†’ areas)

tipo_pregunta_codigo (string, NO FK)

dificultad (Baja | Media | Alta)

enunciado

opciones (JSON almacenado como texto)

respuesta_correcta (Ã­ndice int)

activa

creado_por

âš ï¸ NO cambiar nombres de columnas
âš ï¸ NO forzar normalizaciÃ³n
âš ï¸ NO crear relaciones nuevas sin avisar

ğŸ§ª Tipo de pregunta implementado
SMUR â€“ SelecciÃ³n MÃºltiple Ãšnica Respuesta

Ãšnico tipo aceptado actualmente

Otros tipos deben devolver error controlado

Backend preparado para crecer, pero sin implementarlos aÃºn

ğŸ›‘ Reglas estrictas para ayudarme

âŒ No crear nuevos sistemas de login
âŒ No duplicar JWT
âŒ No usar request.session
âŒ No instalar SessionMiddleware
âŒ No cambiar modelos existentes sin confirmaciÃ³n
âŒ No refactorizar por gusto

âœ… Proponer cambios incrementales
âœ… Indicar siempre archivo y ruta exacta
âœ… Pensar en HTML clÃ¡sico, no en API pura
âœ… Respetar lo que ya funciona

ğŸ¯ Objetivo actual del proyecto

Consolidar un banco de preguntas diagnÃ³sticas sÃ³lido, empezando por SMUR, con un backend:

Coherente

Estable

FÃ¡cil de depurar

Escalable a futuro

Alineado con el ICFES real

Si a partir de ahora ves algo que ya funciona, NO lo rompas.
Si algo requiere tocar BD o auth, avisa antes.

ğŸ’¡ A partir de este contexto, actÃºa como arquitecto y soporte tÃ©cnico del proyecto, no como generador de cÃ³digo genÃ©rico.

Si quieres, en el siguiente mensaje podemos:

Validar SMUR al 100 %

Mejorar UX del modal

Preparar el backend para nuevos tipos

O limpiar deuda tÃ©cnica detectada

ğŸ‘‰ Dime cÃ³mo seguimos ğŸš€



Repositorio del proyecto:
https://github.com/Joaquin-canon/preicfes

Ahora ayÃºdame con el siguiente problema:


